<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infra-Dash | è‡ªåŠ¨åŒ–éƒ¨ç½²ä¸»æ§é¢æ¿</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <h1>Infra-Dash</h1>
                <p>Mac Air / VPS æœåŠ¡å™¨ç®¡ç†ä¸­å¿ƒ</p>
            </div>
            <div class="actions">
                <button id="update-btn" class="btn btn-primary">
                    <span class="icon">ğŸš€</span> å…¨é‡åŒæ­¥æ›´æ–°
                </button>
                <button id="shutdown-btn" class="btn btn-danger">
                    <span class="icon">ğŸ›‘</span> å…¨éƒ¨åœæ­¢
                </button>
                <div class="status-badge" id="server-status">
                    <span class="dot pulse"></span> æœåŠ¡å™¨åœ¨çº¿
                </div>
            </div>
        </header>

        <main>
            <section class="overview">
                <div class="stat-card">
                    <h3>æ´»è·ƒå®¹å™¨</h3>
                    <div class="value" id="active-count">...</div>
                </div>
                <div class="stat-card">
                    <h3>ç³»ç»Ÿè´Ÿè½½</h3>
                    <div class="value">æ­£å¸¸</div>
                </div>
                <div class="stat-card">
                    <h3>å¤–éƒ¨ç«¯å£</h3>
                    <div class="value">8001, 8002</div>
                </div>
            </section>

            <section class="services-section">
                <h2>å¾®æœåŠ¡æ¸…å•</h2>
                <div class="services-grid" id="services-grid">
                    <!-- æœåŠ¡å¡ç‰‡åŠ¨æ€æ³¨å…¥ -->
                    <div class="loading-state">æ­£åœ¨æ‹‰å–å®¹å™¨çŠ¶æ€...</div>
                </div>
            </section>
        </main>

        <footer>
            <p>&copy; 2024 Antigravity Infrastructure Dashboard | <a href="http://localhost:39998" target="_blank"
                    rel="noopener noreferrer">æŸ¥çœ‹
                    Dozzle æ—¥å¿—</a></p>
        </footer>
    </div>

    <!-- å¼¹çª—é€šçŸ¥ -->
    <div id="notification" class="hidden"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Infra-Dash Loaded v1.2');

            const grid = document.getElementById('services-grid');
            const updateBtn = document.getElementById('update-btn');
            const shutdownBtn = document.getElementById('shutdown-btn');
            const notification = document.getElementById('notification');

            function showNotification(message, type = 'info') {
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }

            async function fetchServices() {
                try {
                    const res = await fetch('/api/services');
                    const services = await res.json();
                    renderServices(services);
                    document.getElementById('active-count').textContent = services.filter(s => s.status === 'running').length;
                } catch (err) {
                    showNotification('æ— æ³•è·å–æœåŠ¡åˆ—è¡¨', 'error');
                }
            }

            function renderServices(services) {
                const coreServices = ['infra-dash', 'dozzle'];

                grid.innerHTML = services.map(service => {
                    const isCore = coreServices.includes(service.name);
                    let actionButtons = '';

                    if (service.status === 'running') {
                        // æ ¸å¿ƒæœåŠ¡ä¸æ˜¾ç¤ºåœæ­¢æŒ‰é’®
                        if (!isCore) {
                            actionButtons += `<button onclick="window.controlService('${service.name}', 'stop')" title="åœæ­¢">â¹ï¸</button>`;
                        }
                    } else {
                        actionButtons += `<button onclick="window.controlService('${service.name}', 'start')" title="å¯åŠ¨">â–¶ï¸</button>`;
                    }
                    actionButtons += `<button onclick="window.controlService('${service.name}', 'restart')" title="é‡å¯">ğŸ”„</button>`;

                    return `
                    <div class="service-card ${service.status}">
                        <div class="status-indicator"></div>
                        <div class="service-info">
                            <h3>${service.name} ${isCore ? '<span style="font-size:0.6em;background:#6366f1;padding:2px 6px;border-radius:4px;">CORE</span>' : ''}</h3>
                            <p class="image-tag">${service.image}</p>
                            <p class="status-text">${service.status.toUpperCase()}</p>
                        </div>
                        <div class="service-actions">
                            ${actionButtons}
                        </div>
                    </div>
                `}).join('');
            }

            // å°† controlService æŒ‚è½½åˆ° window å¯¹è±¡ï¼Œä»¥ä¾¿ onclick èƒ½å¤Ÿè°ƒç”¨
            window.controlService = async function (name, action) {
                showNotification(`æ­£åœ¨å¯¹ ${name} æ‰§è¡Œ ${action}...`);
                try {
                    const res = await fetch(`/api/services/${name}/${action}`, { method: 'POST' });
                    const data = await res.json();
                    if (data.status === 'success') {
                        showNotification(`${name} ${action} æˆåŠŸ`, 'success');
                        fetchServices();
                    }
                } catch (err) {
                    showNotification(`æ“ä½œå¤±è´¥: ${err.message}`, 'error');
                }
            };

            if (updateBtn) {
                updateBtn.onclick = async () => {
                    if (!confirm('ç¡®å®šè¦æ‰§è¡Œå…¨é‡åŒæ­¥æ›´æ–°å—ï¼Ÿè¿™å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡çŸ­æ—¶ä¸­æ–­ã€‚')) return;
                    showNotification('å¼€å§‹æ‹‰å–ä»£ç å¹¶é‡å»ºæ‰€æœ‰æœåŠ¡...', 'info');
                    try {
                        const res = await fetch('/api/system/update', { method: 'POST' });
                        showNotification('ç³»ç»Ÿæ›´æ–°ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·è§‚å¯Ÿæ—¥å¿—', 'success');
                        setTimeout(fetchServices, 5000);
                    } catch (err) {
                        showNotification('æ›´æ–°æŒ‡ä»¤å‘é€å¤±è´¥', 'error');
                    }
                };
            }

            if (shutdownBtn) {
                shutdownBtn.onclick = async () => {
                    if (!confirm('âš ï¸ é«˜èƒ½é¢„è­¦ï¼š\n\nç¡®å®šè¦åœæ­¢æ‰€æœ‰åå°æœåŠ¡å—ï¼Ÿ\nè¿™å°†å¯¼è‡´é¢æ¿è‡ªèº«ä¹Ÿè¢«å…³é—­ï¼Œä½ éœ€è¦æ‰‹åŠ¨é€šè¿‡ç»ˆç«¯æ‰èƒ½å†æ¬¡å¯åŠ¨ã€‚')) return;
                    showNotification('æ­£åœ¨ä¸‹è¾¾å…¨çº¿åœæœºæŒ‡ä»¤...', 'error');
                    try {
                        // å‘é€è¯·æ±‚ä½†ä¸ç­‰å¾…å“åº”ï¼Œå› ä¸ºæœåŠ¡ä¼šè‡ªè¡Œåœæ­¢
                        fetch('/api/system/shutdown-all', { method: 'POST' });

                        // æ¨¡æ‹Ÿåœæœºæ•ˆæœ
                        setTimeout(() => {
                            document.body.innerHTML = `
                                <div style="height:100vh;display:flex;justify-content:center;align-items:center;flex-direction:column;color:white;">
                                    <h1 style="font-size:3rem;margin-bottom:20px;">ğŸ›‘ æœåŠ¡å·²åœæ­¢</h1>
                                    <p>æ‰€æœ‰ Docker å®¹å™¨å·²å®‰å…¨å…³é—­ã€‚</p>
                                    <p style="color:#666;margin-top:10px;">å¦‚éœ€æ¢å¤ï¼Œè¯·åœ¨ç»ˆç«¯è¿è¡Œ: cd server && ./update.sh</p>
                                </div>
                            `;
                        }, 2000);
                    } catch (err) {
                        console.error(err);
                    }
                };
            }

            // åˆå§‹æ‹‰å–å¹¶å®šæ—¶åˆ·æ–°
            fetchServices();
            setInterval(fetchServices, 10000);
        });
    </script>
</body>

</html>